FROM ubuntu:latest

RUN sed -i s@/archive.ubuntu.com/@/mirrors.163.com/@g /etc/apt/sources.list \
    && apt-get clean \
    && apt-get update --fix-missing \
    && apt-get upgrade -y \
    && apt-get install -y wget inetutils-ping vim make gcc git autoconf automake byacc flex nano netcat g++ --fix-missing

RUN install -v -d -m 0755 /var/ftp/empty \
    && install -v -d -m 0755 /home/ftp \     
    && groupadd -g 47 vsftpd \               
    && groupadd -g 48 ftp \                  
    && useradd -c "vsftpd User"  -d /dev/null -g vsftpd -s /bin/false -u 47 vsftpd \
    && useradd -c anonymous_user -d /home/ftp -g ftp    -s /bin/false -u 45 ftp 

RUN git clone https://github.com/nikdubois/vsftpd-2.3.4-infected \
    && cd /vsftpd-2.3.4-infected \
    && sed -i -e 's|#define VSF_SYSDEP_HAVE_LIBCAP|//&|' sysdeputil.c \
    && cp Makefile Makefile.bak \
    && sed 's/vsf_findlibs.sh`/& -lcrypt/' Makefile.bak > Makefile \
    && make

RUN mkdir /usr/local/man/man8 \
    && mkdir /usr/local/man/man5 \
    && cd /vsftpd-2.3.4-infected \
    && chmod +x vsf_findlibs.sh \
    && make install \
    && cp vsftpd.conf /etc/vsftpd.conf.bak \
    && sed '$a\secure_chroot_dir=/opt/usr/share/empty' /etc/vsftpd.conf.bak > /etc/vsftpd.conf.bak2 \
    && mkdir -p /opt/usr/share/empty \
    && sed 's/#local_enable=YES/local_enable=YES/' /etc/vsftpd.conf.bak2 > /etc/vsftpd.conf

#COPY ./flag.txt /root/flag.txt

CMD /usr/local/sbin/vsftpd

ENTRYPOINT /usr/local/sbin/vsftpd && /bin/bash
